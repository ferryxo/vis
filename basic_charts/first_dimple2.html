
<!DOCTYPE html>
<html>
  <head>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://dimplejs.org/dist/dimple.v2.1.6.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  </head>
  <body>
    <div>
    <h3>Tooltip Chart</h3>
    <h5>Average scores obtained by students in the different criteria within a given rubric for selected assignment/project.</h5>
    </div>
    <script type="text/javascript">
    // Add a simple SVG element to the body of this document
      var svg = dimple.newSvg("body", 800, 600);
      var data;

      // Create a dataset for 7 students and 5 criterions ( 35 avgscores)
      // studentData.content[0] -> mean scores for 0th student across all criteria
      // studentData.content[0][2] -> mean scores for 0th student for the 2nd criterion.
      var studentData = {

        "x_labels" : ["Criterion 1", "Criterion 2", "Criterion 3", "Criterion 4","Criterion 5" ],
        "y_labels" : ["Student1", "Student2", "Student3", "Student4", "Student5", "Student6", "Student7"],
        "content" :[
            [ 
                {"mean_score" : 50, "variance" : 217.5},
                {"mean_score" : 45, "variance" : 9154.799999999997},
                {"mean_score" : 67, "variance" : 23986.799999999996},
                {"mean_score" : 34, "variance" : 44624.85},
                {"mean_score" : 53, "variance" : 88406.30000000002},
            ], 
            [
                {"mean_score" : 50, "variance" : 161152.5},
                {"mean_score" : 4, "variance" : 278073},
                {"mean_score" : 34, "variance" : 161152.5},
                {"mean_score" : 2, "variance" : 278073},
                {"mean_score" : 80, "variance" : 278073}
            ],
            [
                {"mean_score" : 50, "variance" : 161152.5},
                {"mean_score" : 30, "variance" : 278073},
                {"mean_score" : 80, "variance" : 161152.5},
                {"mean_score" : 90, "variance" : 278073},
                {"mean_score" : 5, "variance" : 278073}
            ],
            [
                {"mean_score" : 10, "variance" : 161152.5},
                {"mean_score" : 0, "variance" : 278073},
                {"mean_score" : 0, "variance" : 161152.5},
                {"mean_score" : 0, "variance" : 278073},
                {"mean_score" : 0, "variance" : 278073}
            ],
            [
                {"mean_score" : 5, "variance" : 161152.5},
                {"mean_score" : 5, "variance" : 278073},
                {"mean_score" : 0, "variance" : 161152.5},
                {"mean_score" : 45, "variance" : 278073},
                {"mean_score" : 100, "variance" : 278073}
            ],
            [ 
                {"mean_score" : 50, "variance" : 217.5},
                {"mean_score" : 50, "variance" : 9154.799999999997},
                {"mean_score" : 50, "variance" : 23986.799999999996},
                {"mean_score" : 50, "variance" : 44624.85},
                {"mean_score" : 50, "variance" : 88406.30000000002},
            ], 
            [ 
                {"mean_score" : 50, "variance" : 217.5},
                {"mean_score" : 50, "variance" : 9154.799999999997},
                {"mean_score" : 50, "variance" : 23986.799999999996},
                {"mean_score" : 50, "variance" : 44624.85},
                {"mean_score" : 50, "variance" : 88406.30000000002},
            ]
        ]
      };


// FOr a particular student, 4 reviewers gave scores for each of the 5 criteria
// reviewdata.content[0][1][3] 0th student , 1st criteria, marks by 3rd reviewer
       var reviewdata = {

        "x_labels" : ["Criterion 1", "Criterion 2", "Criterion 3", "Criterion 4","Criterion 5" ],
        "y_labels" : ["Student1", "Student2", "Student3", "Student4", "Student5", "Student6", "Student7"],
        "z_labels" : [ "r1", "r2", "r3", "r4"],
        "content" :[
            [ 
                [{"score": 60, "comment" : "" }, { "score": 85, "comment" : "" }, { "score": 90, "comment" : "" }, { "score": 100, "comment" : "" } ],
                [{"score": 61, "comment" : "" }, { "score": 85, "comment" : "" }, { "score": 90, "comment" : "" }, { "score": 100, "comment" : "" } ],
                [{"score": 60, "comment" : "" }, { "score": 85, "comment" : "" }, { "score": 90, "comment" : "" }, { "score": 85, "comment":""} ],
                [{"score": 60, "comment" : "" }, { "score": 90, "comment" : "" }, { "score": 100, "comment" : "" }, { "score": 85, "comment":""} ],
                [{"score": 60, "comment" : "" }, { "score": 90, "comment" : "" }, { "score": 100, "comment" : "" }, { "score": 85, "comment":""} ]
            ], 

            [ 
                [{"score": 60, "comment" : "" }, { "score": 85, "comment" : "" }, { "score": 90, "comment" : "" }, { "score": 100, "comment" : "" } ],
                [{"score": 60, "comment" : "" }, { "score": 85, "comment" : "" }, { "score": 90, "comment" : "" }, { "score": 100, "comment" : "" } ],
                [{"score": 60, "comment" : "" }, { "score": 85, "comment" : "" }, { "score": 90, "comment" : "" }, { "score": 85, "comment":""} ],
                [{"score": 60, "comment" : "" }, { "score": 90, "comment" : "" }, { "score": 100, "comment" : "" }, { "score": 85, "comment":""} ],
                [{"score": 60, "comment" : "" }, { "score": 90, "comment" : "" }, { "score": 100, "comment" : "" }, { "score": 85, "comment":""} ]
            ], 


            [ 
                [{"score": 60, "comment" : "" }, { "score": 85, "comment" : "" }, { "score": 90, "comment" : "" }, { "score": 100, "comment" : "" } ],
                [{"score": 60, "comment" : "" }, { "score": 85, "comment" : "" }, { "score": 90, "comment" : "" }, { "score": 100, "comment" : "" } ],
                [{"score": 60, "comment" : "" }, { "score": 85, "comment" : "" }, { "score": 90, "comment" : "" }, { "score": 85, "comment":""} ],
                [{"score": 60, "comment" : "" }, { "score": 90, "comment" : "" }, { "score": 100, "comment" : "" }, { "score": 85, "comment":""} ],
                [{"score": 60, "comment" : "" }, { "score": 90, "comment" : "" }, { "score": 100, "comment" : "" }, { "score": 85, "comment":""} ]
            ], 

            [ 
                [{"score": 60, "comment" : "" }, { "score": 85, "comment" : "" }, { "score": 90, "comment" : "" }, { "score": 100, "comment" : "" } ],
                [{"score": 60, "comment" : "" }, { "score": 85, "comment" : "" }, { "score": 90, "comment" : "" }, { "score": 100, "comment" : "" } ],
                [{"score": 60, "comment" : "" }, { "score": 85, "comment" : "" }, { "score": 90, "comment" : "" }, { "score": 85, "comment":""} ],
                [{"score": 60, "comment" : "" }, { "score": 90, "comment" : "" }, { "score": 100, "comment" : "" }, { "score": 85, "comment":""} ],
                [{"score": 60, "comment" : "" }, { "score": 90, "comment" : "" }, { "score": 100, "comment" : "" }, { "score": 85, "comment":""} ]
            ], 

            [ 
                [{"score": 60, "comment" : "" }, { "score": 85, "comment" : "" }, { "score": 90, "comment" : "" }, { "score": 100, "comment" : "" } ],
                [{"score": 60, "comment" : "" }, { "score": 85, "comment" : "" }, { "score": 90, "comment" : "" }, { "score": 100, "comment" : "" } ],
                [{"score": 60, "comment" : "" }, { "score": 85, "comment" : "" }, { "score": 90, "comment" : "" }, { "score": 85, "comment":""} ],
                [{"score": 60, "comment" : "" }, { "score": 90, "comment" : "" }, { "score": 100, "comment" : "" }, { "score": 85, "comment":""} ],
                [{"score": 60, "comment" : "" }, { "score": 90, "comment" : "" }, { "score": 100, "comment" : "" }, { "score": 85, "comment":""} ]
            ], 

            [ 
                [{"score": 60, "comment" : "" }, { "score": 85, "comment" : "" }, { "score": 90, "comment" : "" }, { "score": 100, "comment" : "" } ],
                [{"score": 60, "comment" : "" }, { "score": 85, "comment" : "" }, { "score": 90, "comment" : "" }, { "score": 100, "comment" : "" } ],
                [{"score": 60, "comment" : "" }, { "score": 85, "comment" : "" }, { "score": 90, "comment" : "" }, { "score": 85, "comment":""} ],
                [{"score": 60, "comment" : "" }, { "score": 90, "comment" : "" }, { "score": 100, "comment" : "" }, { "score": 85, "comment":""} ],
                [{"score": 60, "comment" : "" }, { "score": 90, "comment" : "" }, { "score": 100, "comment" : "" }, { "score": 85, "comment":""} ]
            ], 

            [ 
                [{"score": 60, "comment" : "" }, { "score": 85, "comment" : "" }, { "score": 90, "comment" : "" }, { "score": 100, "comment" : "" } ],
                [{"score": 60, "comment" : "" }, { "score": 85, "comment" : "" }, { "score": 90, "comment" : "" }, { "score": 100, "comment" : "" } ],
                [{"score": 60, "comment" : "" }, { "score": 85, "comment" : "" }, { "score": 90, "comment" : "" }, { "score": 85, "comment":""} ],
                [{"score": 60, "comment" : "" }, { "score": 90, "comment" : "" }, { "score": 100, "comment" : "" }, { "score": 85, "comment":""} ],
                [{"score": 60, "comment" : "" }, { "score": 90, "comment" : "" }, { "score": 100, "comment" : "" }, { "score": 85, "comment":""} ]
            ], 

        ]
}


    var x_labels = [] ;
    var y_labels = [] ;
    var content = [] ;
    var scores_per_student = {} ;
    var average_per_student = [] ;
    var variance_per_student = [] ;
    var opacity_per_student = [] ;
    var processed_student_data = [] ;
    var processed_reviewer_data = [];
    var scores_per_criterion = {} ;
    var average_per_criterion = {} ;
    var variance_per_criterion = {} ;

    // $.getJSON("data.json", function(studentData) {
    d3.json("data.json", function(data){
        x_labels = studentData.x_labels;
        y_labels = studentData.y_labels;
        content = studentData.content;
        // scores_per_student = get_scores_for_each_student(content);  // <student, array of scores>
        // average_per_student = get_avg_scores_per_student(scores_per_student);
        // variance_per_student =  get_variance_per_student(scores_per_student, average_per_student) ;
        // debugger;

         // opacity_per_student = set_opacity_and_colors_based_on_variance(variance_per_student);
         // debugger;
    processed_student_data = processRawStudentData();
    processed_reviewer_data = processRawReviewerData();

      // The main chart
      var myChart = new dimple.chart(svg, processed_reviewer_data);
          // debugger;

      // The chart to show in a tooltip
      var tipChart = null;
      // The other popup shapes
      var popup = null;
     // Position the main chart
      myChart.setBounds(60, 40, 500, 320);
      
      // Add the main chart axes
      // var x = myChart.addCategoryAxis("x", "criterion");
      var x = myChart.addCategoryAxis("x", "Criterion");
      // var y = myChart.addCategoryAxis("y", "studentName");
      var y = myChart.addCategoryAxis("y", "Student");
      var z = myChart.addMeasureAxis("z", "Mean Of Scores");
      myChart.addColorAxis("Standard Deviation", ["#DA9694", "#FABF8F", "#C4D79B"])
      var s = myChart.addSeries(["Variance"], dimple.plot.bubble);

      // debugger;
      myChart.draw();
    });


    function processRawStudentData(){
        
        var raw_student_data = studentData.content ;
        for( var i = 0; i < raw_student_data.length; i++ ){ //student
            for( var j = 0; j < raw_student_data[i].length; j++ ){ // criteria
                processed_student_data.push({
                    "Student": studentData.y_labels[i],
                    "Criterion" : studentData.x_labels[j],
                    "MeanScore" : raw_student_data[i][j].mean_score,
                    "Variance" : raw_student_data[i][j].variance
                });
            }
        }
      return processed_student_data;
    }
// reviewdata.content[0][1][3] 0th student , 1st criteria, marks by 3rd reviewer
    function processRawReviewerData(){
        var raw_review_data = reviewdata.content;

        for( var i = 0; i < raw_review_data.length; i++ ){ //student
            
            for( var j = 0; j < raw_review_data[i].length; j++ ){ // criteria
                row = {} ;
                row['Student'] =  reviewdata.y_labels[i];
                row['Criterion'] = reviewdata.x_labels[j] ;
                // debugger;
                var sum  = 0.0;
                var avg = 0.0;
               
                var review_count = 0 ;

                for( var k = 0; k < raw_review_data[i][j].length; k++ ){ // reviewer
                                    // debugger;
                    var temp_score = raw_review_data[i][j][k].score ;
                    var label = 'Score By ' + reviewdata.z_labels[k] ;
                    row[label] = temp_score ;
                    sum = sum + temp_score;
                    review_count++ ;
                    // debugger;
                }
                avg = sum/ review_count;
                row["Mean Of Scores"] = avg;
                var sum_of_diff_squares = 0.0;
                var std_deviation = 0.0;

                for( var k = 0; k < raw_review_data[i][j].length; k++ ){ // reviewer
                    var temp_score = raw_review_data[i][j][k].score ;
                    sum_of_diff_squares += Math.pow((temp_score - avg) , 2);
                }
                std_deviation = Math.sqrt(sum_of_diff_squares/review_count);
                row["Standard Deviation"] = std_deviation;
                // debugger;
                // console.log(row);
                processed_reviewer_data.push(row);
            }
        }
        console.table(processed_reviewer_data);
        // debugger;
        return processed_reviewer_data;
    }
     

    function get_avg_scores_for_each_criterion(scores_per_criterion){

        average_per_criterion = {} ;
        var sum = 0.0 ;
        var avg = 0.0 ;
        var keys  = Object.keys(scores_per_criterion); 
        var criterion_num = 0 ;

        for( var key in scores_per_criterion){
            var num = 0;    
            for( var i = 0 ; i < scores_per_criterion[key].length; i++){
                sum = sum + scores_per_criterion[key][i];
                num = i + 1;
            }
            avg = sum / num ;
            // debugger;
            average_per_criterion[key] = avg ;
            reviewer_criteria_data_clone.content[criterion_num].push({"average": avg});
            criterion_num = criterion_num + 1 ;
        } 
// debugger;
        return average_per_criterion;
    }
      // // Position the main chart
      // myChart.setBounds(60, 40, 500, 320);
      
      // // Add the main chart axes
      // // var x = myChart.addCategoryAxis("x", "criterion");
      // var x = myChart.addCategoryAxis("x", "x_labels");
      // // var y = myChart.addCategoryAxis("y", "studentName");
      // var y = myChart.addCategoryAxis("y", "y_labels");
      // var z = myChart.addMeasureAxis("z", "mean_score");
      // // myChart.addColorAxis("variance", ["#DA9694", "#FABF8F", "#C4D79B"])
      // var s = myChart.addSeries(null, dimple.plot.bubble);

      // Handle the hover event - overriding the default behaviour
      // s.addEventHandler("click", onClick);
      // Handle the leave event - overriding the default behaviour
      // s.addEventHandler("mouseup", onMouseLeave);
      // myChart.addLegend(180, 1, 360, 20, "right");
      // myChart.defaultColors = [
//     new dimple.color("#333333"),
//     new dimple.color("#666666"),
//     new dimple.color("#999999"),
//     new dimple.color("#BBBBBB"),
//     new dimple.color("#EEEEEE")
// ]; 
      // myChart.defaultColors = [
      // new dimple.color("#07FA07"),
      // new dimple.color("#FAA4A4"), // Set a red fill with a blue stroke
      // new dimple.color("#F50404"), // Set a green fill with a darker green stroke
      // new dimple.color("#A4FAA4") // Set a blue fill with a darker blue stroke

      // set_opacity_and_colors_based_on_variance(variance_per_student);

    //   function set_opacity_and_colors_based_on_variance(variance_per_student){
    //     var opacity_per_student = [] ;
    //     // F4D03F - default
    //     // F50404 - red
    //     // 07FA07 - green
    //     var myColor = [] ;
    //     for( var i = 0 ; i < variance_per_student.length; i++){
    //         // Default color
    //         myColor.push(new dimple.color("F4D03F"));
    //         // green color
    //         myColor.fill = "07FA07";
    //         myColor.opacity = variance_per_student[i];
    //         // myChart.defaultColors.push(myColor);
    //         // myChart.assignColor("Coolio", "red", "black", 1);

    //     }
    //     // return opacity_per_student;
    // }


// ]; 
      // debugger; 

      // myChart.draw();

      // Event to handle mouse enter
      function onClick(e) {
        
        // Get the properties of the selected shape
        var cx = parseFloat(e.selectedShape.attr("cx")),
            cy = parseFloat(e.selectedShape.attr("cy")),
            r = parseFloat(e.selectedShape.attr("r")),
            fill = e.selectedShape.attr("fill"),
            stroke = e.selectedShape.attr("stroke");
            
        // Set the size and position of the popup
        var width = 150,
            height = 100,
            x = (cx + r + width + 10 < svg.attr("width") ?
                  cx + r + 10 :
                  cx - r - width - 20);
            y = (cy - height / 2 < 0 ?
                  15 :
                  cy - height / 2);
                
        // Fade the popup fill mixing the shape fill with 80% white
        var popupFillColor = d3.rgb(
                    d3.rgb(fill).r + 0.8 * (255 - d3.rgb(fill).r),
                    d3.rgb(fill).g + 0.8 * (255 - d3.rgb(fill).g),
                    d3.rgb(fill).b + 0.8 * (255 - d3.rgb(fill).b)
                );
        
        // Create a group for the popup objects
        popup = svg.append("g");
        
        // Add a rectangle surrounding the chart
        popup
          .append("rect")
          .attr("x", x + 5)
          .attr("y", y - 5)
          .attr("width", width)
          .attr("height", height)
          .attr("rx", 5)
          .attr("ry", 5)
          .style("fill", popupFillColor)
          .style("stroke", stroke)
          .style("stroke-width", 2);
        
        // Add the series value text
        popup
          .append("text")
          .attr("x", x + 10)
          .attr("y", y + 10)
          .text(e.yValue +  ', '+ e.xValue)
          .style("font-family", "sans-serif")
          .style("font-size", 6)
          .style("fill", stroke);
        
        // Filter the data for the selected student and criterion
        var hoverData = dimple.filterData(studentReviewerData, "criterion", e.xValue);
        hoverData = dimple.filterData(hoverData, "studentName", e.yValue);
        
        // Create a new mini chart of scores given by different Reviewers
        tipChart = new dimple.chart(svg,  hoverData);
        tipChart.setBounds(x + 10, y + 30, width - 10, height - 40);
        tipChart.addCategoryAxis("x", "reviewer").hidden = false;
        tipChart.addMeasureAxis("y", "scores").hidden = true;
        
        // Add a bar series, this can be changed to a line, area or bubble
        // by changing the plot parameter accordingly.
        var popUpSeries = tipChart.addSeries("SelectedSeries", dimple.plot.bar);
        
        // Set the gap to 80% - just a style preference
        popUpSeries.barGap = 0.5;
        
        // Set the color to the stroke color of the selected node
        tipChart.assignColor("SelectedSeries", stroke, stroke);
        
        // Draw the mini chart
        tipChart.draw();
      };

        // Event to handle mouse exit
      function onMouseLeave(e) {
        // Remove the chart
        if (tipChart !== null) {
          tipChart._group.remove();
        }
        // Remove the popup
        if (popup !== null) {
          popup.remove();
        }
      };
    </script>
  </body>
</html>
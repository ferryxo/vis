<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="http://dimplejs.org/dist/dimple.v2.0.0.min.js"></script>
  <script type="text/javascript">

  </script>
</head>
<body>
<script type="text/javascript">

    var reviewer_criteria_data = {
    "x_labels" : ["Criterion 1", "Criterion 2", "Criterion 3", "Criterion 4", "Criterion 5", "Criterion 6", "Criterion 7"],
    "y_labels" : ["Reviewer 1", "Reviewer 2", "Reviewer 3", "Reviewer 4","Reviewer 5"],
    "color_scheme": {
        "color_1" : "",
        "color_2" : "", 
        "color_3" : ""
    },
    "is_mean_score_user_specified" : "false",
    "content": [
        [
            { "score": 60, "comment" : "" }, 
            { "score": 85, "comment" : "" }, 
            { "score": 90, "comment" : "" }, 
            { "score": 100, "comment" : "" }, 
            { "score": 85, "comment" : ""} 
        ],
 
        [
            { "score": 20, "comment" : "", },
            { "score": 25, "comment" : "", }, 
            { "score": 10, "comment" : "", }, 
            { "score": 40, "comment" : "", }, 
            { "score": 23, "comment" : "", }
        ],
        
        [
            { "score": 09,  "comment" : "", }, 
            { "score": 06,  "comment" : "", }, 
            { "score": 10,  "comment" : "", }, 
            { "score": 20,  "comment" : "",}, 
            { "score": 52,  "comment" : "", }
        ],
        
        [   { "score": 78 , "comment" : "", }, 
            { "score": 65,  "comment" : "", }, 
            { "score": 75, "comment" : "", }, 
            { "score": 49,  "comment" : "", }, 
            { "score": 25,  "comment" : "", }
        ],

        [
            { "score": 68,  "comment" : "", }, 
            { "score": 46,  "comment" : "", }, 
            { "score": 10,  "comment" : "", }, 
            { "score": 67,  "comment" : "", }, 
            { "score": 84,  "comment" : "", }
        ],
      
        [
            { "score": 39,  "comment" : "",}, 
            { "score": 45,  "comment" : "",}, 
            { "score": 78,  "comment" : "",},
            { "score": 93,  "comment" : "",}, 
            { "score": 65,  "comment" : "",}
        ],

        [
            { "score": 30,  "comment" : "",}, 
            { "score": 35,  "comment" : "",}, 
            { "score": 16,  "comment" : "",}, 
            { "score": 79,  "comment" : "",}, 
            { "score": 92,  "comment" : "", }
        ]
    ]
};

    var svg = dimple.newSvg("body", 800, 600);
    var data;
    var x_labels = [] ;
    var y_labels = [] ;
    var content = [] ;
    var scores_per_criterion = {} ;
    var average_per_criterion = {} ;
    var variance_per_student = [] ;
    var colors = [] ;
    var is_mean_score_user_specified = reviewer_criteria_data.is_mean_score_user_specified;
    var reviewer_criteria_data_clone = JSON.parse(JSON.stringify(reviewer_criteria_data));

    // d3.json("reviewer_criteria_data.json", function(data){
        // debugger;
    x_labels = reviewer_criteria_data.x_labels;
    y_labels = reviewer_criteria_data.y_labels;
    colors.push(reviewer_criteria_data.color_scheme.color_1);
    colors.push(reviewer_criteria_data.color_scheme.color_2);
    colors.push(reviewer_criteria_data.color_scheme.color_3);
    content = reviewer_criteria_data.content;
    scores_per_criterion = get_scores_for_each_criterion(content);  // <student, array of scores>
    average_per_criterion = get_avg_scores_for_each_criterion(scores_per_criterion);
    variance_per_criterion =  get_variance_for_each_criterion(scores_per_criterion, average_per_criterion) ;

    // }); end of function

    function get_scores_for_each_criterion(content){
        // Map storing scores for each student, key is student, value is an array of scores for that student.
        var scores_per_criterion = {} ;
        var temp_scores = [] ;

        for (var i = 0; i < content.length; i++) { //Iterates over each criterion

            for (var j = 0; j < content[i].length; j++) { // iterate over scores of each criterion.
                temp_scores.push(content[i][j].score);
                                   // debugger;
            }                            
            scores_per_criterion[x_labels[i]] = temp_scores ;
                          // debugger; 

            temp_scores = [] ;
        }
        return scores_per_criterion;
    }

    function get_avg_scores_for_each_criterion(scores_per_criterion){

        average_per_criterion = {} ;
        var sum = 0.0 ;
        var avg = 0.0 ;
        var keys  = Object.keys(scores_per_criterion); 
        var criterion_num = 0 ;

        for( var key in scores_per_criterion){
            var num = 0;    
            for( var i = 0 ; i < scores_per_criterion[key].length; i++){
                sum = sum + scores_per_criterion[key][i];
                num = i + 1;
            }
            avg = sum / num ;
            // debugger;
            average_per_criterion[key] = avg ;
            reviewer_criteria_data_clone.content[criterion_num].push({"average": avg});
            criterion_num = criterion_num + 1 ;
        } 
// debugger;
        return average_per_criterion;
    }

    function get_variance_for_each_criterion(scores_per_criterion, average_per_criterion){
        var variance_per_criterion = {} ;
        // if( is_mean_score_user_specified ){
            
        // }else{
            var num = 0 ;
            var sum = 0.0;
            var variance = 0.0 ;
            var keys  = Object.keys(scores_per_criterion); 
            var criterion_num = 0 ;

            for( var key in scores_per_criterion){

                for( var i = 0 ; i < scores_per_criterion[key].length; i++){

                sum = sum + Math.pow((scores_per_criterion[key][i] - average_per_criterion[key]), 2 );
                num = i ;
                }   
                variance = sum/ num;
                variance_per_criterion[key] = variance;
                reviewer_criteria_data_clone.content[criterion_num].push({"variance": variance});
                criterion_num = criterion_num + 1 ;
            }
        // }
                        // debugger;

        return variance_per_criterion;
    }

      // The main chart
    var myChart = new dimple.chart(svg, reviewer_criteria_data_clone);
    // The chart to show in a tooltip
    var tipChart = null;
    // The other popup shapes
    var popup = null;

    // Position the main chart
    myChart.setBounds(60, 40, 500, 320);
      
        // Add the main chart axes
    var x = myChart.addCategoryAxis("x", x_labels);
    var y = myChart.addCategoryAxis("y", y_labels);
    var z = myChart.addMeasureAxis("z", "average");
    var s = myChart.addSeries(null, dimple.plot.bubble);
        // debugger;

    myChart.draw();

</script>
</body>
</html>
